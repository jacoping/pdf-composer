<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Generatore Fuoriporta v0.1</title>
		<script src="js/pdfkit.js"></script>
		<script src="js/blob-stream.js"></script>
		<script src="js/pdf.js"></script>

		<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css"> -->
		<link rel="stylesheet" href="css/skeleton.min.css" >
    <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web:200,400,700"> -->
    <link rel="stylesheet" href="css/fonts.css" >
    <link rel="stylesheet" href="css/styles.css" >


	</head>
	<body>
		<section id="control">
			<header>
				<!-- <img src="images/banner_dida.svg" alt="" id="photo" width="260px" height="auto"> -->
        <h5>Generatore Fuoriporta (beta)</h5>
        <h6>versione 0.2</h6>
			</header>


			<main class="main_input-container">

        <div id="select_container">
          <label>Scegli una struttura:
  					<select onchange="popola_info_struttura()" id="struttura_selector">
  					</select>
  				</label>
        </div>

				<div id="text_input_container">
				</div>

				<div id="control-panel">
					<div class="options-input">
            <input type="radio" name="options-color" id="options-color-black" value="black" checked>
						<label class=radio-label>Sfondo nero</label>
            <input type="radio" name="options-color" d="options-color-white" value="white">
            <label class=radio-label>Sfondo bianco</label>
            <input type="checkbox" id="options-margins" >
						<label class=checkbox-label>Mostra le guide</label>
					</div>
					<button id="aggiorna_pdf" onclick="aggiorna_pdf()">Aggiorna l'anteprima</button>
					<a href="" id="scarica_link" download="Fuoriporta Novoli.pdf">Scarica il pdf</a>
				</div>

			</main>
		</section>

		<section id="preview">
			<header>
				<h5>Anteprima PDF</h5>
			</header>
			<main>
				<canvas id="the-canvas"></canvas>
			</main>
		</section>






		<script>


		// ---------------------------------
		// ----------- SETTINGS ------------
		// ---------------------------------

			// impostazioni PDF, in mm
			var pdf_larg = 200;
			var pdf_alt = 110;

			var pdf_msu = 12;
			var pdf_mgiu = 10;

			var pdf_msx = 10;
			var pdf_mdx = 10;

      var lista_strutture = [
        {
          option_ref: "DipDISEI",
          option_name: "DISEI",
          struttura_bold_1: "DISEI",
          struttura_light_1: "Dipartimento di",
          struttura_light_2: "Scienze per l'Economia e per l'Impresa"
        },
        {
          option_ref: "DipDSG",
          option_name: "DSG",
          struttura_bold_1: "DSG",
          struttura_light_1: "Dipartimento di",
          struttura_light_2: "Scienze Giuridiche"
        },
        {
        option_ref: "DipDSPS",
        option_name: "DSPS",
        struttura_bold_1: "DSPS",
        struttura_light_1: "Dipartimento di",
        struttura_light_2: "Scienze Politiche e Sociali"
        },
        {
          option_ref: "ScGiuripsrudenza",
          option_name: "Scuola di Giuripsrudenza",
          struttura_bold_1: "Scuola di",
          struttura_bold_2: "Giurisprudenza",
        },
        {
          option_ref: "Libera",
          option_name: "-- Compilazione libera --",
          struttura_bold_1: "Struttura Bold 1",
          struttura_bold_2: "Struttura Bold 2",
          struttura_bold_3: "Struttura Bold 3",
          struttura_light_1: "Struttuera Light 1",
          struttura_light_2: "Struttura Light 2"        }
      ];

      var struttura_current;


      // ---------------------------------
			// ---- generates input fields -----
			// ---------------------------------


      function create_select_input(container) {
        var select = document.querySelector("#struttura_selector");
        first_option = document.createElement("option");
        first_option.setAttribute("selected", "selected");
        first_option.setAttribute("disabled", "disabled");
        first_option.innerHTML = "...";
        select.appendChild(first_option);
        for (i=0; i < lista_strutture.length; i++) {
          var option = document.createElement("option");
          option.value = lista_strutture[i].option_ref;
          option.innerHTML = lista_strutture[i].option_name;
          select.appendChild(option)
        };
      }

      function create_text_input(container, enabled, etichetta, id, value, ) {
				var label = document.createElement("label");
				label.textContent = etichetta;
				var input = document.createElement("input");
				input.setAttribute("type", "text");
				input.setAttribute("class", "input_field");
				input.setAttribute("id", id);
        if (!enabled) {
					input.setAttribute("disabled", "disabled");
				};
				if (value) {
					input.setAttribute("value", value);
				};
				input.setAttribute("autocomplete", "nope");
				label.appendChild(input);
				container.appendChild(label);
			}

      function popola_info_struttura() {
        let index = document.querySelector("#struttura_selector").selectedIndex;
        console.log(index);
        struttura_selezionata = (lista_strutture[index-1]);
        show_text_fields(struttura_selezionata);
      }

      function show_text_fields(struttura) {
        container = document.querySelector("#text_input_container");
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        // crea gli input di struttura
				enabled = (struttura.option_ref==="Libera") ? true : false;
        create_text_input(container, enabled, "Struttura Bold 1:",  "struttura_b1", 	 struttura.struttura_bold_1);
        create_text_input(container, enabled, "Struttura Bold 2:", "struttura_b2", 		struttura.struttura_bold_2);
        create_text_input(container, enabled, "Struttura Bold 3:", "struttura_b3", 		struttura.struttura_bold_3);
        create_text_input(container, enabled, "Struttura Light 1:", "struttura_l1", 		struttura.struttura_light_1);
        create_text_input(container, enabled, "Struttura Light 2:", "struttura_l2", 		struttura.struttura_light_2);
        // crea gli altri input
				create_inputs_funzioni(container);
        create_inputs_nomi(container);
        // aggiunge nota in fondo
        let note = document.createElement("h6");
        NB: note.innerHTML = "Per lasciare vuota una riga inserire uno spazio.";
        container.appendChild(note);
        // aggiorna il PDF
        aggiorna_pdf();
      }

			function create_inputs_funzioni(container) {
				let box = document.createElement("div");
				box.setAttribute("class", "input_box");
					create_text_input(box, "enabled", "Funzione 1:", 				"funzione_1", 			"Funzione 1");
					create_text_input(box, "enabled", "Funzione 2:", 				"funzione_2", 			"Funzione 2");
					create_text_input(box, "enabled", "Funzione 3:", 				"funzione_3", 			"Funzione 3");
				container.appendChild(box);
			}

      function create_inputs_nomi(container) {
        create_text_input(container, "enabled", "Nome 1:", 						"nome_1", 					"Nome 1");
        create_text_input(container, "enabled", "Nome 2:", 						"nome_2", 					"");
        create_text_input(container, "enabled", "Nome 3:", 						"nome_3", 					"");
        create_text_input(container, "enabled", "Nome 4:", 						"nome_4", 					"");
        create_text_input(container, "enabled", "Nome 5:", 						"nome_5", 					"");
        create_text_input(container, "enabled", "Nome 6:", 						"nome_6", 					"");
        create_text_input(container, "enabled", "Nome 7:", 			      "nome_7", 			    "");
        create_text_input(container, "enabled", "Specifica:", 				"specifica", 				"Specifica");
      }


			// ---------------------------------
			// ---- CREATE PDF WITH PDFKIT -----
			// ---------------------------------

			// Helper function: converts mm to pdf-units
			function mmToUnits(mm){
				units = mm * 2.8368794326;
				return units;
			}

			// Main function: aggiorna pdf e visualizza anteprima
			function aggiorna_pdf(){

				//Setup PDF document
				doc = new PDFDocument({
					autoFirstPage: false
				});
				stream = doc.pipe(blobStream())

				// Aggiungi pagina
				doc.addPage({
					size: [mmToUnits(pdf_larg), mmToUnits(pdf_alt)],
					margins: {
						top: mmToUnits(pdf_msu),
						bottom: mmToUnits(pdf_mgiu),
						left: mmToUnits(pdf_msx),
						right: mmToUnits(pdf_mdx)
					}
				});

				// Mostra i margini se necessario
				if (document.querySelector("#options-margins").checked == true) {

					doc.rect(mmToUnits(pdf_msx), mmToUnits(pdf_msu), mmToUnits(pdf_larg - pdf_msx - pdf_mdx), mmToUnits(pdf_alt - pdf_msu - pdf_mgiu))
						.fill("red")

					doc.moveTo(0, mmToUnits(38))
						.lineTo(mmToUnits(200), mmToUnits(38))
						.lineWidth(.5)
						.stroke("black");

					doc.moveTo(0, mmToUnits(40.7))
						.lineTo(mmToUnits(200), mmToUnits(40.7))
						.lineWidth(.5)
						.stroke("black");

					doc.moveTo(0, mmToUnits(95))
						.lineTo(mmToUnits(200), mmToUnits(95))
						.lineWidth(.5)
						.stroke("black");

          doc.moveTo(0, mmToUnits(5))
						.lineTo(mmToUnits(200), mmToUnits(5))
						.lineWidth(1)
						.stroke("blue");

          doc.moveTo(0, mmToUnits(105))
						.lineTo(mmToUnits(200), mmToUnits(105))
						.lineWidth(1)
						.stroke("blue");
				}

        // Select colors
        var pdf_background = "#fff";
        var pdf_foreground = "#000";
        if (document.querySelector("#options-color-black").checked == true) {
          pdf_background = "#000";
          pdf_foreground = "#fff";

          doc.rect(0, 0, mmToUnits(pdf_larg), mmToUnits(pdf_alt))
            .fill(pdf_background)
        }



				// Carica contenuto
				/*
				Come scrivere questa parte: dividerla in tre momenti

				- momento 1: inizializzazione e reset variabili
				- momento 2: caricamento informazioni
					una funzione carica le info dagli input fields e assegna ogni informazione a delle variabili predeterminate
				- momento 3: scrittura PDF
					pdf kit scrive sul pdf in posizioni prefissate delle righe di testo per tutte le variabili che trova riempite
				*/

        // Crea variabili informazioni

        var St_b1 = "";
				var St_b2 = "";
				var St_b3 = "";
				var St_l1 = "";
				var St_l2 = "";
				var Fu_1 = "";
				var Fu_2 = "";
				var Fu_3 = "";
        var Nomi = [];


        // Carica informazioni

				St_b1 = document.querySelector("#struttura_b1") ? document.querySelector("#struttura_b1").value : "";
				St_b2 = document.querySelector("#struttura_b2") ? document.querySelector("#struttura_b2").value : "";
				St_b3 = document.querySelector("#struttura_b3") ? document.querySelector("#struttura_b3").value : "";
				St_l1 = document.querySelector("#struttura_l1") ? document.querySelector("#struttura_l1").value : "";
				St_l2 = document.querySelector("#struttura_l2") ? document.querySelector("#struttura_l2").value : "";

		    Fu_1 = document.querySelector("#funzione_1") ? document.querySelector("#funzione_1").value : "";
				Fu_2 = document.querySelector("#funzione_2") ? document.querySelector("#funzione_2").value : "";
				Fu_3 = document.querySelector("#funzione_3") ? document.querySelector("#funzione_3").value : "";

        Nomi = [];
				Nomi[0] = document.querySelector("#nome_1") ? document.querySelector("#nome_1").value : "";
				Nomi[1] = document.querySelector("#nome_2") ? document.querySelector("#nome_2").value : "";
				Nomi[2] = document.querySelector("#nome_3") ? document.querySelector("#nome_3").value : "";
				Nomi[3] = document.querySelector("#nome_4") ? document.querySelector("#nome_4").value : "";
				Nomi[4] = document.querySelector("#nome_5") ? document.querySelector("#nome_5").value : "";
				Nomi[5] = document.querySelector("#nome_6") ? document.querySelector("#nome_6").value : "";
				Nomi[6] = document.querySelector("#nome_7") ? document.querySelector("#nome_7").value : "";
				Nomi[7] = document.querySelector("#specifica") ? document.querySelector("#specifica").value : "";



        // Impostazioni layout
        var left_textbox_width = mmToUnits(130);
				var right_textbox_width = mmToUnits(90);

        // NOMI: carattere 20/16pt spazio sotto 4pt
        var nomi_options = { align: 'right', width: right_textbox_width, lineGap: -8, paragraphGap: 4};

        // NOMI: carattere 20/16pt spazio sotto 4pt
        var strutture_options = { align: 'right', width: left_textbox_width, lineGap: -8, paragraphGap: 4};


        // Calcolo allineamento parte destra
        doc.font(helvetica75, 20); // sets ght fonts for the right calculations
        var lines_total_height= 0;
        Nomi.forEach (function(e) {
          var w = doc.widthOfString(e, nomi_options);
          var h = doc.heightOfString(e, nomi_options);
          lines_total_height += doc.heightOfString(e, nomi_options)
          // console.log (e + " // width: " + w.toFixed(1) + " height: " + h);
        });
        offset = 241 - lines_total_height;
        // console.log ("altezza totale: " + lines_total_height)
        // console.log ("offset (199-h): " + offset);





        // Scrivi info su PDF
				doc.fill (pdf_foreground);

				doc.font(helvetica95, 30)
					.text(St_b1,              { width: left_textbox_width, paragraphGap: mmToUnits(-3.4) })
					.text(St_b2,              { width: left_textbox_width, paragraphGap: mmToUnits(-3.4) })
					.text(St_b3,              { width: left_textbox_width, paragraphGap: mmToUnits(-3) })
					.font(helvetica45, 18)
					.text(St_l1,              { width: left_textbox_width, paragraphGap: mmToUnits(-1) })
					.text(St_l2,              { width: left_textbox_width, paragraphGap: mmToUnits(0) })
          .font(helvetica65, 2).text(" ")  // questa linea serve come interlinea (brutto ma funziona)
          .font(helvetica65, 20)
					.text(Fu_1,               { width: left_textbox_width, lineGap: mmToUnits(-1.4) })
					.text(Fu_2,               { width: left_textbox_width, lineGap: mmToUnits(-1.4) })
					.text(Fu_3,               { width: left_textbox_width, lineGap: mmToUnits(-1.4) });

          // lineGap: -1.4

					doc.font(helvetica75, 20)
						.text(Nomi[0], mmToUnits(pdf_larg - pdf_mdx)-right_textbox_width, mmToUnits(pdf_msu)+offset,
																		nomi_options)
						.text(Nomi[1], 					nomi_options)
						.text(Nomi[2], 					nomi_options)
						.text(Nomi[3], 					nomi_options)
						.text(Nomi[4], 					nomi_options)
						.text(Nomi[5], 					nomi_options)
						.text(Nomi[6], 					nomi_options)
						.font(helvetica45, 20)
						.text(Nomi[7], 					nomi_options);


				// Chiudi PDF e visualizza
				doc.end();
				stream.on('finish', function() {
					pdf_url = stream.toBlobURL('application/pdf')
					// iframe.src = pdf_url;
					aggiorna_PDF(pdf_url);
					link=document.querySelector("#scarica_link");
					link.href=pdf_url;
				});
			}


			// ---------------------------------
			// ----- VISUALIZE WITH PDF.JS -----
			// ---------------------------------

			PDFJS.workerSrc = 'js/pdf.worker.js';

			// Asynchronous download of PDF

			var aggiorna_PDF = function(url) {
				var loadingTask = PDFJS.getDocument(url);
				loadingTask.promise.then(function(pdf) {
					console.log('PDF loaded');

					// Fetch the first page
					var pageNumber = 1;
					pdf.getPage(pageNumber).then(function(page) {
						console.log('Page loaded');

						var scale = 5;
						var viewport = page.getViewport(scale);

						// Prepare canvas using PDF page dimensions
						var canvas = document.getElementById('the-canvas');
						var context = canvas.getContext('2d');
						canvas.height = viewport.height;
						canvas.width = viewport.width;
						canvas.style.width = "100%";
						canvas.style.height = "100%";

						// Render PDF page into canvas context
						var renderContext = {
							canvasContext: context,
							viewport: viewport
						};
						var renderTask = page.render(renderContext);
						renderTask.then(function () {
							console.log('Page rendered');
						});
					});
				}, function (reason) {
					// PDF loading error
					console.error(reason);
				});
			};





      // ---------------------------------
			// ------ LOAD FONTS WITH XHR ------
			// ---------------------------------

			var xhr_to_load = 0;

			// load font helvetica black
			xhr_to_load ++;
			var xhr = new XMLHttpRequest();
			xhr.open( "GET", "./fonts/HelveticaNeueLTPro-Blk.otf", true );
			xhr.responseType = "arraybuffer";
			xhr.onload = function( e ) {
				helvetica95 = this.response;
				console.log("font loaded");
				xhr_to_load --;
				if (xhr_to_load === 0) {async_trigger()};
			};
			xhr.send();

			// load font helvetica bold
			xhr_to_load ++;
			var xhr = new XMLHttpRequest();
			xhr.open( "GET", "./fonts/HelveticaNeueLTPro-Bd.otf", true );
			xhr.responseType = "arraybuffer";
			xhr.onload = function( e ) {
				helvetica75 = this.response;
				console.log("font loaded");
				xhr_to_load --;
				if (xhr_to_load === 0) {async_trigger()};
			};
			xhr.send();

			// load font helvetica medium
			xhr_to_load ++;
			var xhr = new XMLHttpRequest();
			xhr.open( "GET", "./fonts/HelveticaNeueLTPro-Md.otf", true );
			xhr.responseType = "arraybuffer";
			xhr.onload = function( e ) {
				helvetica65 = this.response;
				console.log("font loaded");
				xhr_to_load --;
				if (xhr_to_load === 0) {async_trigger()};
			};
			xhr.send();

			// load font helvetica light
			xhr_to_load ++;
			var xhr = new XMLHttpRequest();
			xhr.open( "GET", "./fonts/HelveticaNeueLTPro-Lt.otf", true );
			xhr.responseType = "arraybuffer";
			xhr.onload = function( e ) {
				helvetica45 = this.response;
				console.log("font loaded");
				xhr_to_load --;
				if (xhr_to_load === 0) {async_trigger()};
			};
			xhr.send();

			function async_trigger() {
				aggiorna_pdf();
			};


			// ---------------------------------
			// ----------- INIZIALIZZA ---------
			// ---------------------------------

      create_select_input(document.querySelector("#select_container"));

  </script>

	</body>
</html>
